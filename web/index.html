<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Meal Plan 2026</title>
  <style>
    :root { --primary: #4a90e2; --secondary: #2ecc71; --bg: #f4f7f6; --text: #2c3e50; }
    body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); padding: 20px; }
    .container { max-width: 1200px; margin: 0 auto; }
    .hidden { display: none; }
    .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }

    /* –¢–∞–±–ª–∏—Ü–∞ */
    table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; }
    th, td { border: 1px solid #e0e6ed; padding: 12px; text-align: center; }
    th { background: var(--primary); color: white; }
    .meal-type-label { background: #f8fafd; font-weight: bold; text-align: left; width: 120px; }

    /* –≠–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */
    .btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; color: white; }
    .btn-add { background: var(--secondary); margin-bottom: 20px; }
    .btn-save { background: var(--primary); }
    .btn-back { background: #95a5a6; }
    select { width: 100%; padding: 8px; border: 1px solid #dcdfe6; border-radius: 4px; background: #fff; }
  </style>
</head>
<body>

<div class="container">
  <div id="page-dashboard">
    <h1>üóì –ü–ª–∞–Ω –Ω–∞ –Ω–µ–¥–µ–ª—é</h1>
    <button class="btn btn-add" onclick="showPage('page-add-dish')">+ –ù–æ–≤–æ–µ –±–ª—é–¥–æ</button>

    <table>
      <thead>
      <tr id="header-days">
        <th>–í—Ä–µ–º—è</th>
      </tr>
      </thead>
      <tbody id="plan-body">
      </tbody>
    </table>
  </div>

  <div id="page-add-dish" class="hidden">
    <div class="card">
      <h2>ü•ò –°–æ–∑–¥–∞—Ç—å –±–ª—é–¥–æ –∏ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç</h2>
      <div style="margin-bottom: 20px;">
        <label><b>–ù–æ–≤—ã–π –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç:</b></label><br>
        <input type="text" id="ing-name" placeholder="–ù–∞–ø—Ä: –ö—É—Ä–∏—Ü–∞">
        <button class="btn btn-save" onclick="saveIngredient()">–î–æ–±–∞–≤–∏—Ç—å</button>
      </div>
      <hr>
      <div>
        <label><b>–ù–∞–∑–≤–∞–Ω–∏–µ –±–ª—é–¥–∞:</b></label>
        <input type="text" id="dish-name" style="width:100%; margin: 10px 0; padding: 8px;">
        <label>–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã:</label>
        <div id="ingredients-list" style="display: grid; grid-template-columns: 1fr 1fr; margin: 10px 0;"></div>
        <button class="btn btn-save" onclick="saveDish()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –±–ª—é–¥–æ</button>
        <button class="btn btn-back" onclick="showPage('page-dashboard')">–ù–∞–∑–∞–¥</button>
      </div>
    </div>
  </div>
</div>

<script>
  // –ù–∞–∑–≤–∞–Ω–∏—è –¥–æ–ª–∂–Ω—ã —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å —Ç–µ–º–∏, —á—Ç–æ –ø—Ä–∏—Ö–æ–¥—è—Ç –∏–∑ –±–∞–∑—ã (GetWeeklyPlan)
  const DAYS = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
  const MEAL_TYPES = ['Breakfast', 'Lunch', 'Dinner', 'Snack'];

  let state = { dishes: [], ingredients: [], weekly_plan: {} };

  async function loadData() {
    const res = await fetch('/dashboard');
    state = await res.json();
    renderTable();
    renderIngredients();
  }

  function renderTable() {
    const header = document.getElementById('header-days');
    const body = document.getElementById('plan-body');

    // –†–∏—Å—É–µ–º —à–∞–ø–∫—É
    header.innerHTML = '<th>–í—Ä–µ–º—è</th>' + DAYS.map(d => `<th>${d}</th>`).join('');

    // –†–∏—Å—É–µ–º —Å—Ç—Ä–æ–∫–∏
    body.innerHTML = '';
    MEAL_TYPES.forEach((type, typeIdx) => {
      let row = `<tr><td class="meal-type-label">${type}</td>`;

      DAYS.forEach((day, dayIdx) => {
        // –ò—â–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ç–≤–æ–µ–≥–æ WeeklyPlan (map[string][]MealDetail)
        const dayPlan = state.weekly_plan[day] || [];
        const currentMeal = dayPlan.find(m => m.meal_type === type);

        row += `<td>
                    <select onchange="updatePlan(${dayIdx + 1}, ${typeIdx + 1}, this.value)">
                        <option value="">-- –ø—É—Å—Ç–æ --</option>
                        ${state.dishes.map(d => `
                            <option value="${d.id}" ${currentMeal && currentMeal.dish_name === d.name ? 'selected' : ''}>
                                ${d.name}
                            </option>
                        `).join('')}
                    </select>
                </td>`;
      });
      body.innerHTML += row + '</tr>';
    });
  }

  async function updatePlan(dayId, mealTypeId, dishId) {
    if (!dishId) return;
    await fetch('/plan/item', {
      method: 'PUT',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ day_id: dayId, meal_type_id: mealTypeId, dish_id: parseInt(dishId) })
    });
  }

  // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
  function showPage(id) {
    document.getElementById('page-dashboard').classList.toggle('hidden', id !== 'page-dashboard');
    document.getElementById('page-add-dish').classList.toggle('hidden', id !== 'page-add-dish');
    if(id === 'page-dashboard') loadData();
  }

  function renderIngredients() {
    const container = document.getElementById('ingredients-list');
    container.innerHTML = state.ingredients.map(i => `
            <label><input type="checkbox" value="${i.id}" class="ing-check"> ${i.name}</label>
        `).join('');
  }

  async function saveIngredient() {
    const name = document.getElementById('ing-name').value;
    await fetch('/ingredients', {
      method: 'PUT',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ name })
    });
    document.getElementById('ing-name').value = '';
    loadData();
  }

  async function saveDish() {
    const name = document.getElementById('dish-name').value;
    const ids = Array.from(document.querySelectorAll('.ing-check:checked')).map(c => parseInt(c.value));
    await fetch('/dishes', {
      method: 'PUT',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ name, ingredient_ids: ids })
    });
    showPage('page-dashboard');
  }

  loadData();
</script>
</body>
</html>
